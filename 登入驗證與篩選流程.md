# 登入驗證與篩選流程架構文件

本文件整理了 `myweb` 專案中關於登入驗證、憑證發放以及 Filter 攔截驗證的完整架構。

## 1. 系統架構圖 (Architecture Diagram)

系統採用經典的 MVC 與分層架構，並透過 Servlet Filter 實現斷點攔截驗證。

```mermaid
graph TD
    Client[("瀏覽器 (Client)")]
    
    subgraph Web_Layer ["Web 層 (Servlet / Filter)"]
        Filter["UserValidFilter<br/>(驗證攔截器)"]
        LoginCtrl["LoginController<br/>(登入控制器)"]
    end
    
    subgraph Service_Repository_Layer ["業務邏輯與資料層"]
        UserRepo["UserRepository<br/>(資料存取)"]
    end
    
    subgraph Database ["資料庫"]
        DB[("Northwnd DB<br/>(OnLineUsers Table)")]
    end
    
    Client -- 1. 登入請求 --> LoginCtrl
    LoginCtrl -- 2. 驗證身分 --> UserRepo
    UserRepo -- 3. 查詢 --> DB
    LoginCtrl -- 4. 發放憑證 (Cookie/Session) --> Client
    
    Client -- 5. 資源請求 (如 /customer/*) --> Filter
    Filter -- 6. 憑證比對 (Double Check) --> Client
    Filter -- 7. 驗證通過 --> ProtectedResource["受保護資源"]
    Filter -- 8. 驗證失敗 --> LoginCtrl
```

---

## 2. 類別圖 (Class Diagram)

展示參與登入與驗證流程的核心類別及其關係。

```mermaid
classDiagram
    class UserValidFilter {
        +doFilter(ServletRequest, ServletResponse, FilterChain)
        +init(FilterConfig)
    }
    
    class LoginController {
        -UserRepository repository
        +doGet(HttpServletRequest, HttpServletResponse)
        +doPost(HttpServletRequest, HttpServletResponse)
    }
    
    class UserRepository {
        -JdbcTemplate jdbcTemplate
        +findById(String k) OnLineUsers
    }
    
    class OnLineUsers {
        -String userName
        -String password
        -String realName
        -String email
        +getUserName()
        +getPassword()
    }
    
    class IOperations {
        <<interface>>
        +findById(K k) T
    }
    
    LoginController o-- UserRepository : consumes
    UserRepository ..|> IOperations : implements
    UserRepository --> OnLineUsers : manages
    UserValidFilter ..> LoginController : redirects to
```

---

## 3. 循序圖 (Sequence Diagram)

### 3.1 登入與憑證發放流程

描述使用者登入成功並取得憑證的過程。

```mermaid
sequenceDiagram
    participant U as 使用者 (Browser)
    participant LC as LoginController
    participant UR as UserRepository
    participant DB as 資料庫
    
    U->>LC: POST /login (username, password)
    LC->>UR: findById(username, password)
    UR->>DB: SELECT * FROM OnLineUsers WHERE ...
    DB-->>UR: 傳回查詢結果
    UR-->>LC: 返回 OnLineUsers 物件
    
    Note over LC: 驗證成功 (users != null)
    
    LC->>U: 1. Add Cookie (".cred", username)
    LC->>LC: 2. Set Session Attribute (".cred", username)
    LC-->>U: Forward to login.jsp (帶入成功訊息)
```

### 3.2 資源存取與 Filter 攔截流程

描述使用者存取受保護資源時，Filter 如何進行攔截與驗證。

```mermaid
sequenceDiagram
    participant U as 使用者 (Browser)
    participant F as UserValidFilter
    participant S as HttpSession
    participant R as 受保護資源 (如 /customer/all)
    
    U->>F: GET /customer/all
    Note over F: 檢查路徑包含 "/customer"
    
    F->>U: 擷取 Cookie (".cred")
    F->>S: 擷取 Session Attribute (".cred")
    
    alt 憑證比對成功 (Cookie == Session)
        F->>R: chain.doFilter() (通過攔截)
        R-->>U: 回傳資源內容
    else 憑證缺失或不匹配
        F->>U: response.sendRedirect("/login")
        Note over U: 使用者被導引回登入頁
    end
```

---

## 4. 關鍵實作說明

### 4.1 憑證安全性 (Security)
在 `LoginController` 中，憑證採取了以下安全措施：
*   **HttpOnly**: 防止 JavaScript 存取 Cookie，降低 XSS 攻擊風險。
*   **Secure**: 僅允許透過 HTTPS 傳輸憑證（在生產環境中非常重要）。
*   **SameSite=Lax**: 防止 CSRF（跨站請求偽造）攻擊，限制 Cookie 在跨站請求中的傳遞。

### 4.2 雙重驗證機制 (Double Check)
`UserValidFilter` 不僅檢查瀏覽器端是否有帶回 `Cookie`，還會同步比對伺服器端的 `HttpSession` 內容。只有當兩者皆存在且值相符時，才視為合法登入狀態。

### 4.3 攔截範圍
Filter 佈署於 `/*`，但僅針對路徑中包含 `/customer` 的請求進行強制驗證。其餘請求（如首頁、登入頁等）則直接放行。
